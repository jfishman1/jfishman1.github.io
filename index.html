<!DOCTYPE html>
<html>
<head>
  <title>OneSignal Examples Page</title>
<!-- Google Analytics -->
<script>
  // Used from: https://developers.google.com/analytics/devguides/collection/analyticsjs
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-106423818-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<!-- End Google Analytics -->

<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
<script>
  var OneSignal = window.OneSignal || [];
  OneSignal.push(function() {
    OneSignal.init({
      appId: "3beb3078-e0f1-4629-af17-fde833b9f716",
    });
  });
</script>

</head>
<body>
  <h1> OneSignal Examples </h1>
  <div>
    <ul>
      <li><a href='https://jfishman1.github.io/tagging'>Tagging example</a></li>
      <li><a href='https://jfishman1.github.io/ga'>Google Analytics example</a></li>
      <li><a href="https://jfishman1.github.io/cross-origin-example">Cross-origin Subscription tracking Example</a></li>
      <li><a href='https://jfishman1.github.io/geolocation'>GeoLocation example</a></li>
      <li><a href='https://jfishman1.github.io/subdirectory/subdirectory-testpage'>Subdirectory Test Page</a></li>
      <li><a href='https://jfishman1.github.io/testpage'>Test Page</a></li>
      <li><a href='https://jfishman1.github.io/prompt-delay-seconds'>Delay prompt 30 seconds example</a></li>
      <li><a href='https://jfishman1.github.io/prompt-delay-visits'>Delay prompt 3 visits example</a></li>
      <!--<li><a href='https://jfishman1.github.io/http-setup'>HTTP Example</a></li>-->
    </ul>
  </div>
  <p><button onclick="tagUser()">Tag User</button></p>
  <p><button onclick="sendSelfNotification()">Send Self Notification</button></p>
<script>

function tagUser() {
  OneSignal.push(function() {
    let timestamp = Math.floor(Date.now() / 1000);
    OneSignal.sendTag("buttonPress", timestamp).then(function(tagsSent) {
      // Callback called when tags have finished sending
      console.log("timestamp = ", timestamp);
    });
  })
}

function sendSelfNotification() {
  OneSignal.push(function() {
    OneSignal.sendSelfNotification();
  });
}
  
OneSignal.push(["addListenerForNotificationOpened", function(payload) {
  console.log("OneSignal Notification Clicked Paylaod:");
  console.log(payload);
  console.log(payload.data);
  var topic = payload.data.topic;
  console.log("topic: ", topic);
  OneSignal.sendTag("topic", topic).then(function(tagsSent) {
    console.log("tagsSent: ", tagsSent)
  });
  OneSignal.getUserId( function(userId) {
    console.log("OneSignal User ID:", userId);
    // Make a POST call to GA with the notification data and userId aka playerId
    // https://developers.google.com/analytics/devguides/collection/analyticsjs/sending-hits#hitcallback
    ga('send', {
      hitType: 'event', 
      eventCategory: 'notification_clicked', 
      eventAction: 'u_id ' + userId, 
      eventLabel: 'n_id ' + payload.id,
      hitCallback: function() {
        console.log("ga notification click callback");
      }
    });
  });
}]);

OneSignal.push(function() {
    // Occurs when the user's subscription changes to a new value.
    OneSignal.on('notificationPermissionChange', function(permissionChange) {
      var currentPermission = permissionChange.to;
      console.log('New permission state:', currentPermission);
      OneSignal.getUserId( function(userId) {
        ga('send', {
          hitType: 'event',
          eventCategory: 'notification_permission_change',
          eventAction: currentPermission,
          eventLabel: 'u_id ' + userId, 
          hitCallback: function() {
            console.log("ga permission change callback");
          }
        });
      });
   });
});

OneSignal.push(function() {
  // Occurs when native browser prompt is shown
  OneSignal.on('permissionPromptDisplay', function() {
    console.log("The native prompt displayed");
    ga('send', {
      hitType: 'event',
      eventCategory: 'notification_prompt',
      eventAction: 'displayed',
      hitCallback: function() {
        console.log("ga permission display callback");
      }
    });
  });
});

OneSignal.push(function() {
  OneSignal.on('notificationDisplay', function (event) {
    console.log('OneSignal notification displayed:', event);
    console.log('OneSignal notification id:', event.id);
    console.log('OneSignal notification title:', event.heading);
    console.log('OneSignal notification content:', event.content);
    console.log('OneSignal notification url:', event.url);
    console.log('OneSignal notification icon:', event.icon);
  });
});

OneSignal.push(function() {
  // Occurs when the user's subscription changes to a new value.
  OneSignal.on('subscriptionChange', function (isSubscribed) {
    console.log("The user's subscription state is now:", isSubscribed);
  });
  
  // This event can be listened to via the `on()` or `once()` listener.
});

</script>
  
</body>
</html>